# GNU screen title
if [ "$TERM" = "screen" ]; then
  preexec() {
    emulate -L zsh
    local -a cmd; cmd=(${(z)2})
    case $cmd[1] in
      fg)
        if (( $#cmd == 1 )); then
          cmd=(builtin jobs -l %+)
        else
          cmd=(builtin jobs -l $cmd[2])
        fi
        ;;
      %*) 
        cmd=(builtin jobs -l $cmd[1])
        ;;
      (gnu|)ls|gvim(.sh|))
        return
        ;; 
      cd)
        if (( $#cmd == 2)); then
          cmd[1]=$cmd[2]:t
        else
          cmd[1]="~"
        fi
        change_hardstatus $cmd[1]
        return
        ;;
      vi(m|))
        if (( $#cmd == 2)); then
          cmd[1]="v:$cmd[2]:t"
        fi
        change_hardstatus $cmd[1]
        return
        ;;
      *)
        change_hardstatus $cmd[1]:t
        return
        ;;
    esac

    local -A jt; jt=(${(kv)jobtexts})

    $cmd >>(
      read num rest
      cmd=(${(z)${(e):-\$jt$num}})
      echo -n "k$cmd[1]:t\\"
    ) 2>/dev/null
  }

  change_hardstatus() {
    echo -n "k$1\\"
  }
fi
